<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <title>js practice</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
      $(function() {
        var
          linkList = [],
          idCount  = 1;
        $('#addBtn').on('click', function() {
          $('#warning').empty();
          var
            getName    = $('#name').val(),
            getUrl     = $('#url').val(),
            resultList = [];

          resultList = setEmptyJudgment(getName, getUrl);
          if(resultList.length > 0) {
            setError(resultList, '未入力');
            return;
          };

          resultList = setDuplicateJudgment(getName, getUrl);
          if(resultList.length > 0) {
            setError(resultList, '重複');
            return;
          };

          linkList.push({id:idCount,name:getName,url:getUrl});
          idCount++;
          var
            length = linkList.length;
            $('#linktable').empty();

          for(var i = 0; i < length; i++) {
            $('#linktable').append($('<tr>').attr('id', linkList[i].id)
              .append($('<td>').append($('<a>').attr('href', linkList[i].url).text(linkList[i].name)))
              .append($('<td>').append($('<button>').attr('class', 'edit').text('編集')))
              .append($('<td>').append($('<button>').attr('class', 'delete').text('削除'))));
          };
          $('#name').val("");
          $('#url').val("");
        });
        $(document).on('click', '.edit', function() {
          $('.textEdit').removeClass('textEdit');
          $(this).parents('tr').addClass('textEdit');
          var 
            nameEdit = $('.textEdit').find('a').text(),
            urlEdit  = $('.textEdit').find('a').attr('href'),
            idEdit   = $('.textEdit').attr('id');
          $('#name').val(nameEdit);
          $('#url').val(urlEdit);
          $('#id').val(idEdit);

          $('#addBtn').hide();
          $('#saveBtn').show();
        });
        $(document).on('click', '#saveBtn', function() {
          var
            nameEdit   = $('.textEdit').find('a').text(),
            urlEdit    = $('.textEdit').find('a').attr('href'),
            addName    = $('#name').val(),
            addUrl     = $('#url').val(),
            resultList = [],
            noEdit     = 0,
            editTarget = 2;

          resultList = setEmptyJudgment(addName, addUrl);
          if(resultList.length > 0) {
            setError(resultList, '未入力');
            return;
          };

          resultList = setDuplicateJudgment(addName, addUrl, '変更');
          if(!$.isArray(resultList)) {
            setError([], '変更');
            return;
          };

          if(resultList.length > 0) {
            setError(resultList, '重複');
            return;
          };

          var
           idEdit = $('.textEdit').attr('id'),
           length = linkList.length;
          $.each(linkList, function(i, val) {
            if(parseInt(idEdit, 10) === val.id) {
              val.name = addName;
              val.url = addUrl;
            };
          });
          $('.textEdit').find('a').attr('href', addUrl).text(addName);
          $('#addBtn').show();
          $('#saveBtn').hide();
          $('#warning').empty();
          $('.textEdit').removeClass('textEdit');
          $('#name').val("");
          $('#url').val("");
        });
        $(document).on('click', '.delete', function() {
          var
            idEdit = $(this).parents('tr').attr('id');
          $.each(linkList, function(i, val) {
            if(parseInt(idEdit, 10) === val.id) {
              linkList.splice(i,1);
              return false;
            };
          });
          $(this).parents('tr').remove();
        });
        function setEmptyJudgment(name, url) {
          var errorList = [];
          if(name == '') {
            errorList.push('リンク名');
          };
          if(url == '') {
            errorList.push('URL');
          };
          return errorList;
        };
        function setDuplicateJudgment(name, url, op = '') {
          var
            errorList     = [],
            setName       = '',
            setUrl        = '',
            setList       = $('.link').find('a'),
            setListLength = setList.length,
            nameEdit      = '',
            urlEdit       = '',
            noEdit        = 0,
            editTarget    = 2;

          if(op === '変更') {
            nameEdit = $('.textEdit').find('a').text();
            urlEdit = $('.textEdit').find('a').attr('href');
          };

          for(var i = 0; i < setListLength; i++) {
            setName = setList.eq(i).text();
            setUrl = setList.eq(i).attr('href');
            if(name === setName) {
              if(name === nameEdit) {
                noEdit++;
              }else {
                errorList.push('リンク名');
              };
            };
            if(url === setUrl) {
              if(url === urlEdit) {
                noEdit++;
              }else {
                errorList.push('URL');
              };
            };
          };
          if(noEdit === editTarget) {
            return 'noEdit';
          };
          return errorList;
        };
        function setError(list, kind) {
          var
            length    = list.length,
            errorText = '',
            i;

          for(i = 0; i < length; i++) {
            if(i > 0) {
              errorText += '・';
            };
            errorText += list[i];
          };
          switch(kind) {
            case '未入力':
              errorText += 'を入力してください';
              break;
            case '重複':
              errorText += 'はすでに登録されています。';
              break;
            case '変更':
              errorText += '変更されてません';
            break;
          };
          $('#warning').text(errorText).css('color', 'red');
        };
      });
    </script>
  </head>
  <body>
    <section class="form">
      <form action="#" method="POST">
        <p>
          <input id="id" type="hidden" name="id" value="">
        </p>
        <p>
          <label for="name">リンク名</label><br>
          <input id="name" type="text" name="name"><br>
        </p>
        <p>
          <label for="url">URL</label><br>
          <input id="url" type="url" name="url"><br>
        </p>
        <p>
          <input id="addBtn" type="button" name="btn" value="リンク追加">
          <input id="saveBtn" type="button" name="btn" value="変更を保存する">
        </p>
      </form>
    </section>
    <section id="warning"></section>
    <section class="link">
      <table id="linktable"></table>
    </section>
  </body>
</html>